erDiagram
    USERS {
        uuid id PK "DEFAULT uuid_generate_v4()"
        varchar email "NOT NULL, UNIQUE"
        varchar name "NOT NULL"
        timestamptz created_at "NOT NULL, DEFAULT now()"
        timestamptz updated_at "NOT NULL, DEFAULT now()"
    }

    PAYMENT_METHOD_TYPES {
        uuid id PK "DEFAULT uuid_generate_v4()"
        varchar code "NOT NULL, UNIQUE"
        varchar name "NOT NULL"
        text description "NULL"
        boolean is_active "NOT NULL, DEFAULT true"
        boolean requires_brand "NOT NULL, DEFAULT false"
        boolean requires_last4 "NOT NULL, DEFAULT false"
        varchar icon_url "NULL"
        timestamptz created_at "NOT NULL, DEFAULT now()"
        timestamptz updated_at "NOT NULL, DEFAULT now()"
    }

    USER_PAYMENT_METHODS {
        uuid id PK "DEFAULT uuid_generate_v4()"
        uuid user_id FK "NOT NULL, REFERENCES USERS(id)"
        uuid payment_method_type_id FK "NOT NULL, REFERENCES PAYMENT_METHOD_TYPES(id)"
        varchar brand "NULL, e.g. VISA, MASTERCARD"
        varchar last4 "NULL, CHECK pattern"
        text details_encrypted "NOT NULL, KMS-managed"
        boolean is_default "NOT NULL, DEFAULT false"
        boolean is_active "NOT NULL, DEFAULT true"
        timestamptz created_at "NOT NULL, DEFAULT now()"
        timestamptz updated_at "NOT NULL, DEFAULT now()"
    }


    PAYMENTS {
        uuid id PK "DEFAULT uuid_generate_v4()"
        uuid user_id FK "NOT NULL, REFERENCES USERS(id)"
        uuid order_id "NOT NULL"
        integer amount "NOT NULL, CHECK > 0"
        char currency "NOT NULL, CHECK pattern"
        enum status "NOT NULL, DEFAULT PENDING"
        uuid payment_method_id FK "NULL, REFERENCES USER_PAYMENT_METHODS(id)"
        jsonb gateway_response "NOT NULL, DEFAULT '{}'"
        varchar idempotency_key "NULL, UNIQUE"
        timestamptz created_at "NOT NULL, DEFAULT now()"
        timestamptz updated_at "NOT NULL, DEFAULT now()"
    }

    REFUNDS {
        uuid id PK "DEFAULT uuid_generate_v4()"
        uuid payment_id FK "NOT NULL, REFERENCES PAYMENTS(id)"
        integer amount "NOT NULL, CHECK > 0"
        char currency "NOT NULL, CHECK pattern"
        enum status "NOT NULL, DEFAULT PENDING"
        text reason "NULL, Refund reason"
        varchar idempotency_key "NULL, UNIQUE"
        timestamptz created_at "NOT NULL, DEFAULT now()"
        timestamptz updated_at "NOT NULL, DEFAULT now()"
    }

    USERS ||--o{ USER_PAYMENT_METHODS : "user_owns_and_manages_saved_payment_methods"
    USERS ||--o{ PAYMENTS : "user_initiates_payment_transactions"
    PAYMENT_METHOD_TYPES ||--o{ USER_PAYMENT_METHODS : "payment_type_defines_user_payment_method_structure"
    USER_PAYMENT_METHODS ||--o{ PAYMENTS : "saved_payment_method_processes_payment_transactions"
    PAYMENTS ||--o{ REFUNDS : "payment_can_have_multiple_refund_requests"